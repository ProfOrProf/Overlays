<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>HAPPY BIRTHDAY – FrankBigTime!!!</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{ --purple:#b06fff; --teal:#47eaff; }
  html,body{ height:100%; margin:0; background:transparent; overflow:hidden; }

  .stage{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }

  /* Title (DOM blink before canvas takes over) */
  #lines .wrap{
    text-align:center; font-family:'Press Start 2P', monospace;
    color:var(--purple); -webkit-text-stroke:2px var(--teal);
    text-shadow:2px 2px 0 var(--teal), -2px 2px 0 var(--teal), 0 0 18px rgba(71,234,255,.45);
    /* Blink period must match BLINK_PERIOD in JS (850ms) */
    animation: blink .85s steps(1,end) infinite;
  }
  .line{ display:block; margin:12px 0; }
  .l1,.l2{ font-size: clamp(20px,5vw,64px); }
  .l3{     font-size: clamp(24px,6vw,76px); }
  @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:0} }

  /* Canvas used for both dissolves */
  #c{ position:absolute; inset:0; width:100vw; height:100vh; display:none; }

  /* Cake */
  #cakeStage{ flex-direction:column; gap:20px; opacity:0; transition:opacity .6s ease-out; }
  #cakeBox{
    border:2px solid var(--teal); border-radius:14px; padding:20px;
    background:rgba(0,0,0,.05); box-shadow:0 0 16px rgba(71,234,255,.35);
  }
  #candles,#cake{
    font-family:ui-monospace,Consolas,monospace; white-space:pre; text-align:center;
    font-size:clamp(14px,3.6vw,34px); color:var(--purple);
  }
  .candle{display:inline-block;}
  .blow{ animation:gust 1.4s steps(1,end) forwards; }
  @keyframes gust{
    0%{transform:translateX(0);font-style:italic;opacity:1}
    25%{transform:translateX(-8px);font-style:normal;opacity:1}
    50%{transform:translateX(-16px);font-style:italic;opacity:.85}
    75%{transform:translateX(-24px);font-style:normal;opacity:.6}
    100%{transform:translateX(-34px);font-style:italic;opacity:0}
  }
  #btn{ margin-top:10px; padding:8px 12px; border:2px solid var(--teal);
        font-family:'Press Start 2P', monospace; background:var(--teal); cursor:pointer; }
  #btn:hover{ filter:brightness(1.1) }

  /* Finale: Love, Prof (blinks before dissolve) */
  #final{ display:none; }
  #love{
    font-family:'Press Start 2P', monospace; color:var(--purple);
    -webkit-text-stroke:2px var(--teal);
    text-shadow:2px 2px 0 var(--teal), -2px 2px 0 var(--teal), 0 0 18px rgba(71,234,255,.45);
    font-size:clamp(22px,6vw,76px); animation:blink .85s steps(1,end) infinite;
  }
</style>
</head>
<body>

<!-- Title (DOM; will blink 10x, then canvas dissolve takes over) -->
<div id="lines" class="stage">
  <div class="wrap">
    <span class="line l1">HAPPY</span>
    <span class="line l2">BIRTHDAY</span>
    <span class="line l3">FRANKBIGTIME!!!</span>
  </div>
</div>

<!-- Canvas for dissolves -->
<canvas id="c"></canvas>

<!-- Cake -->
<div id="cakeStage" class="stage">
  <div id="cakeBox">
<pre id="candles">
<span class="candle">{} {}  {}  {}  {}  {}  {}  {}</span>
<span class="candle">∥   ∥   ∥   ∥   ∥   ∥    ∥   ∥</span>
</pre>
<pre id="cake">/⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒⌒ヽ
（__/^!/^｀!_/^!_/^!_/^^!_/!_）!_）
|================================|
|================================|
☆＾＾~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~＾＾☆
  ¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨¨</pre>
    <div style="text-align:center"><button id="btn">BLOW ME!</button></div>
  </div>
</div>

<!-- Finale text -->
<div id="final" class="stage"><div id="love">Love, Prof</div></div>

<script>
(() => {
  /* ===== Timings ===== */
  const BLINK_PERIOD       = 850;   // must match CSS blink (.85s)
  const INTRO_BLINKS       = 5;    // <-- blink count for title
  const INTRO_DISSOLVE_MS  = 6500;
  const LOVE_BLINK_MS      = 1800;
  const LOVE_DISSOLVE_MS   = 4200;

  /* ===== Elements ===== */
  const lines     = document.getElementById('lines');
  const cakeStage = document.getElementById('cakeStage');
  const btn       = document.getElementById('btn');
  const final     = document.getElementById('final');

  /* ===== Canvas setup (shared) ===== */
  const CAN = document.getElementById('c');
  const CTX = CAN.getContext('2d');
  const LAYER = document.createElement('canvas');
  const LCTX  = LAYER.getContext('2d', { willReadFrequently:true });
  const PURPLE = '#b06fff', TEAL = '#47eaff', FONT = 'Press Start 2P';

  let metrics = { px:48, rows:[], cx:0, cy:0 };

  function resizeCanvas(){
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio||1));
    CAN.width = Math.floor(CAN.clientWidth*dpr);
    CAN.height= Math.floor(CAN.clientHeight*dpr);
    CTX.setTransform(dpr,0,0,dpr,0,0);
    LAYER.width = CAN.clientWidth; LAYER.height = CAN.clientHeight;
    LCTX.setTransform(1,0,0,1,0,0);
  }

  function layoutRows(rows){
    const base = Math.min(LAYER.width, LAYER.height);
    const px = Math.max(26, Math.floor(base*0.07));
    LCTX.font = `${px}px "${FONT}", monospace`;
    LCTX.textBaseline = 'alphabetic';

    const gap = Math.floor(px*0.38);
    const m = LCTX.measureText("M");
    const unitH = (m.actualBoundingBoxAscent||px*0.9)+(m.actualBoundingBoxDescent||px*0.2);
    const heights = rows.map(()=>unitH);
    const totalH = heights.reduce((a,b)=>a+b,0)+gap*(rows.length-1);

    let y = (LAYER.height-totalH)/2 + heights[0];
    const info = rows.map((text,i)=>{
      const w=LCTX.measureText(text).width;
      const x=(LAYER.width-w)/2; const yi=y; y += (i<rows.length-1? heights[i]+gap : 0);
      return {text,x,y:yi,w,h:heights[i]};
    });
    metrics = { px, rows:info, cx:LAYER.width/2, cy:LAYER.height/2 };
  }

  function drawRowsToLayer(){
    LCTX.clearRect(0,0,LAYER.width,LAYER.height);
    LCTX.lineJoin='round'; LCTX.strokeStyle=TEAL; LCTX.lineWidth=Math.max(3, Math.round(metrics.px*0.22));
    LCTX.font=`${metrics.px}px "${FONT}", monospace`; LCTX.textBaseline='alphabetic';
    metrics.rows.forEach(r=>{
      LCTX.strokeText(r.text, Math.round(r.x), Math.round(r.y));
      LCTX.fillStyle=PURPLE; LCTX.fillText(r.text, Math.round(r.x), Math.round(r.y));
    });
  }

  const easeOut = t => 1 - Math.pow(1 - t, 3);
  function eraseWithCircle(t){
    const maxR = Math.sqrt((LAYER.width/2)**2 + (LAYER.height/2)**2);
    const r = easeOut(t)*(maxR+6);
    LCTX.save(); LCTX.globalCompositeOperation='destination-out';
    LCTX.beginPath(); LCTX.arc(Math.round(metrics.cx), Math.round(metrics.cy), r, 0, Math.PI*2);
    LCTX.fillStyle='#000'; LCTX.fill(); LCTX.restore();
  }
  function eraseWithStar(t, spins=4.5, thickness=0.08){
    const angle = (Math.PI*2)*(spins*t);
    const L = easeOut(t);
    const fullLen = Math.sqrt(LAYER.width**2 + LAYER.height**2)*2;
    const lenNow = fullLen*L;
    const barH = Math.max(3, Math.round(metrics.px*thickness));
    LCTX.save(); LCTX.globalCompositeOperation='destination-out';
    LCTX.translate(Math.round(metrics.cx), Math.round(metrics.cy));
    LCTX.rotate(angle);
    for(let i=0;i<5;i++){
      LCTX.save(); LCTX.rotate(i*(2*Math.PI/5));
      const x0 = Math.round(-lenNow/2), y0 = Math.round(-barH/2);
      LCTX.fillRect(x0, y0, Math.round(lenNow)+2, barH+2);
      LCTX.restore();
    }
    LCTX.restore();
  }
  function drawStage(){ CTX.clearRect(0,0,CAN.clientWidth,CAN.clientHeight); CTX.drawImage(LAYER,0,0); }

  /* Generic dissolve with progress hook */
  function dissolve(rows, duration, onProgress, onDone){
    CAN.style.display='block';
    resizeCanvas(); layoutRows(rows); drawRowsToLayer(); drawStage();
    let t0;
    function step(now){
      if(!t0) t0=now;
      const t = Math.min(1, (now-t0)/duration);
      eraseWithCircle(t);
      eraseWithStar(t);
      drawStage();
      onProgress && onProgress(t);
      if(t<1){ requestAnimationFrame(step); } else { CAN.style.display='none'; onDone && onDone(); }
    }
    requestAnimationFrame(step);
  }

  /* ===== Intro flow (blink exactly 10 times, then dissolve) ===== */
  setTimeout(()=>{
    // Hide DOM title & start the dissolve render
    lines.style.display='none';
    cakeStage.style.opacity = 0; // will ramp up during dissolve
    dissolve(["HAPPY","BIRTHDAY","FRANKBIGTIME!!!"], INTRO_DISSOLVE_MS, (t)=>{
      // start showing cake around 25% progress, fully visible by ~60%
      if(t>0.25){
        const p = Math.min(1, (t-0.25)/0.35);
        cakeStage.style.opacity = p;
      }
    });
  }, BLINK_PERIOD * INTRO_BLINKS);

  /* ===== Cake interactions -> finale ===== */
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.candle').forEach((el,i)=>{
      el.classList.add('blow'); el.style.animationDelay=`${i*0.05}s`;
      el.addEventListener('animationend',()=> el.style.visibility='hidden', {once:true});
    });
    setTimeout(()=>{
      document.getElementById('cakeBox').remove();
      // Blink "Love, Prof" briefly, then dissolve it away
      final.style.display='flex';
      setTimeout(()=>{
        final.style.display='none';
        dissolve(["Love, Prof"], LOVE_DISSOLVE_MS);
      }, LOVE_BLINK_MS);
    },1600);
  });

  window.addEventListener('resize', ()=>{ if(CAN.style.display==='block'){ resizeCanvas(); drawRowsToLayer(); drawStage(); }});
})();
</script>
</body>
</html>
