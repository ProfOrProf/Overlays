$ErrorActionPreference = 'Stop'

$ESC = [char]27
function rgb($r,$g,$b){@([int]$r,[int]$g,[int]$b)}
$UseAnsi = $true
$G1 = rgb 20 90 20
$G2 = rgb 0 255 0
$DOS = $G2
$White = rgb 255 255 255
$Baby = rgb 137 207 240
$Red = rgb 255 61 61

function escfg($c){"$ESC[38;2;$($c[0]);$($c[1]);$($c[2])m"}
function reset(){"$ESC[0m"}
function line($text,$c,$fallback='White'){ if($UseAnsi){ Write-Host ("{0}{1}{2}" -f (escfg $c),$text,(reset)) } else { Write-Host $text -ForegroundColor $fallback } }
function parts($arr){
  if($UseAnsi){
    $s=''; foreach($p in $arr){ $s += (escfg $p.rgb) + $p.text }; $s += reset; Write-Host $s
  } else {
    foreach($p in $arr){ Write-Host $p.text -NoNewline -ForegroundColor $p.fallback }; Write-Host
  }
}
function grad($lines,$c1,$c2){
  $n = $lines.Count; if($n -lt 1){return}
  for($i=0;$i -lt $n;$i++){
    $r=[int]($c1[0]+($c2[0]-$c1[0])*$i/[Math]::Max(1,$n-1))
    $g=[int]($c1[1]+($c2[1]-$c1[1])*$i/[Math]::Max(1,$n-1))
    $b=[int]($c1[2]+($c2[2]-$c1[2])*$i/[Math]::Max(1,$n-1))
    if($i -lt [Math]::Floor($n/2)){$fallback='DarkGreen'}else{$fallback='Green'}
    line $lines[$i] (rgb $r $g $b) $fallback
  }
}

$banner = @'
                                                                                                
@@@@@@@   @@@@@@@    @@@@@@   @@@@@@@@     @@@@@@    @@@@@@   @@@  @@@  @@@@@@@@   @@@@@@  @@@  
@@@@@@@@  @@@@@@@@  @@@@@@@@  @@@@@@@@    @@@@@@@   @@@@@@@@  @@@  @@@  @@@@@@@@  @@@@@@@  @@@  
@@!  @@@  @@!  @@@  @@!  @@@  @@!         !@@       @@!  @@@  @@!  @@@  @@!       !@@      @@!  
!@!  @!@  !@!  @!@  !@!  @!@  !@!         !@!       !@!  @!@  !@!  @!@  !@!       !@!      !@   
@!@@!@!   @!@!!@!   @!@  !@!  @!!!:!      !!@@!!    @!@!@!@!  @!@  !@!  @!!!:!    !!@@!!   @!@  
!!@!!!    !!@!@!    !@!  !!!  !!!!!:       !!@!!!   !!!@!!!!  !@!  !!!  !!!!!:     !!@!!!  !!!  
!!:       !!: :!!   !!:  !!!  !!:              !:!  !!:  !!!  :!:  !!:  !!:            !:!      
:!:       :!:  !:!  :!:  !:!  :!:             !:!   :!:  !:!   ::!!:!   :!:           !:!  :!:  
 ::       ::   :::  ::::: ::   ::         :::: ::   ::   :::    ::::     :: ::::  :::: ::   ::  
 :         :   : :   : :  :    :          :: : :     :   : :     :      : :: ::   :: : :   :::                                                                                                                       
'@

# split banner safely and widen console to avoid wrap
$bannerLines = ($banner -split '\r?\n').Where({ $_ -ne '' })
try {
  $raw = $Host.UI.RawUI
  $max = ($bannerLines | ForEach-Object Length | Measure-Object -Maximum).Maximum
  $target = [Math]::Min(500, $max + 2)
  $buf = $raw.BufferSize; if ($buf.Width -lt $target) { $buf.Width = $target; $raw.BufferSize = $buf }
  $win = $raw.WindowSize; if ($win.Width -lt $target) { $win.Width = $target; $raw.WindowSize = $win }
} catch {}

grad $bannerLines $G1 $G2

$RootDir = if ($PSScriptRoot) { $PSScriptRoot } else { Split-Path -Parent $MyInvocation.MyCommand.Path }
$LiveName = 'SPRJ0005'
$LiveFolder = Join-Path $RootDir $LiveName
$ConfigPath = Join-Path $RootDir 'ProfSaves-BB.ini'
$BackupsDefault = 5

function Ensure-Dir([string]$Path){ if ([string]::IsNullOrWhiteSpace($Path)) { throw "Ensure-Dir: Path is null/empty." } if (-not (Test-Path -LiteralPath $Path)) { New-Item -ItemType Directory -Path $Path | Out-Null } }
function Read-Ini([string]$Path){ $ini=@{}; if(-not (Test-Path -LiteralPath $Path)){return $ini}; $section=''; foreach($lineRaw in Get-Content -LiteralPath $Path){ $line = ($lineRaw -as [string]).Trim(); if($line -match '^\s*[#;]' -or $line -match '^\s*$'){continue}; if($line -match '^\s*\[(.+?)\]\s*$'){ $section=$Matches[1]; if(-not $ini[$section]){$ini[$section]=@{}}; continue }; if($line -match '^\s*([^=]+?)\s*=\s*(.*)$'){ $k=$Matches[1].Trim(); $v=$Matches[2].Trim(); if(-not $ini[$section]){$ini[$section]=@{}}; $ini[$section][$k]=$v } }; $ini }
function Write-Ini([string]$Path,[hashtable]$Data){ $sb=New-Object System.Text.StringBuilder; foreach($sec in $Data.Keys){ [void]$sb.AppendLine("[$sec]"); foreach($k in $Data[$sec].Keys){ [void]$sb.AppendLine("$k=$($Data[$sec][$k])") }; [void]$sb.AppendLine() }; $dir = Split-Path -Parent $Path; if($dir){ Ensure-Dir $dir }; [IO.File]::WriteAllText($Path,$sb.ToString(),[Text.Encoding]::UTF8) }
function Get-NextSlotNumber([string]$Root){ if(-not (Test-Path -LiteralPath $Root)){return 1}; $nums=Get-ChildItem -LiteralPath $Root -Directory -ErrorAction SilentlyContinue | Where-Object {$_.Name -match '^\d+$'} | ForEach-Object {[int]$_.Name}; if($nums.Count -eq 0){1}else{(($nums | Measure-Object -Maximum).Maximum + 1)} }
function Get-SlotInfo([string]$Root){ $list=@(); if(-not (Test-Path -LiteralPath $Root)){return $list}; $dirs=Get-ChildItem -LiteralPath $Root -Directory -ErrorAction SilentlyContinue | Where-Object {$_.Name -match '^\d+$'} | Sort-Object {[int]$_.Name}; foreach($d in $dirs){ $slot=[int]$d.Name; $saveDir=Join-Path $d.FullName $LiveName; $label=''; $nameTxt=Join-Path $d.FullName 'name.txt'; if(Test-Path -LiteralPath $nameTxt){ $raw=Get-Content -LiteralPath $nameTxt -Raw; $label = ($raw -as [string]) -replace '^\s+|\s+$','' }; $exists=Test-Path -LiteralPath $saveDir; $list += [pscustomobject]@{ Slot=$slot; Exists=$exists; Dir=$d.FullName; SaveDir=$saveDir; Label=$label } }; $list }
function Backup-Folder([string]$Folder,[int]$Keep=$BackupsDefault){ if(-not (Test-Path -LiteralPath $Folder)){return}; $bakRoot=Join-Path $RootDir '_ProfBackups'; Ensure-Dir $bakRoot; $stamp=Get-Date -Format 'yyyyMMdd-HHmmss'; $dest=Join-Path $bakRoot ("{0}.{1}.bak" -f $LiveName,$stamp); Copy-Item -LiteralPath $Folder -Destination $dest -Recurse -Force; Get-ChildItem -LiteralPath $bakRoot -Directory -ErrorAction SilentlyContinue | Where-Object {$_.Name -like "$LiveName.*.bak"} | Sort-Object LastWriteTime -Descending | Select-Object -Skip $Keep | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue }

line "Hey! Prof Saves! What should I call you?" $DOS 'Green'
$cfg=Read-Ini $ConfigPath
if(-not $cfg['User']){$cfg['User']=@{}}
if(-not $cfg['Settings']){$cfg['Settings']=@{}}
if(-not $cfg['Settings']['BackupsToKeep']){$cfg['Settings']['BackupsToKeep']="$BackupsDefault"}
if(-not $cfg['User']['Name'] -or [string]::IsNullOrWhiteSpace($cfg['User']['Name'])){
  line "" $White
  line "What is your Name?" $DOS 'Green'
  $name = Read-Host
  $name = ($name -as [string]) -replace '^\s+|\s+$',''
  if([string]::IsNullOrWhiteSpace($name)){$name='Hunter'}
  $name = $name -replace '[\\/:*?""<>|]','-'
  $cfg['User']['Name']=$name
  Write-Ini $ConfigPath $cfg
}

$UserName=$cfg['User']['Name']
$Keep=[int]($cfg['Settings']['BackupsToKeep'])
$SaveRoot=Join-Path $RootDir $UserName
Ensure-Dir $SaveRoot

if(-not (Test-Path -LiteralPath $LiveFolder)){
  line "" $White
  parts @(@{text="Could not find '$LiveName' next to this script."; rgb=$Red; fallback='Red'})
  line "Put ProfSaves-BB.ps1 and the .bat in the SAME folder as '$LiveName' and run again." $White 'White'
  Read-Host "Press Enter to exit"
  exit 1
}

while($true){
  line "" $White
  line ("Hey, {0}! Prof Saves (Bloodborne) - Which save do you want to LOAD?" -f $UserName) $White 'White'

  $slots=Get-SlotInfo -Root $SaveRoot

  if($slots.Count -eq 0){
    parts @(
      @{text="You don't have any saves yet. Type '"; rgb=$White; fallback='White'},
      @{text="new"; rgb=$Baby; fallback='Cyan'},
      @{text="' to capture your current $LiveName as slot 1."; rgb=$White; fallback='White'}
    )
  } else {
    foreach($s in $slots){
      if(-not $s.Exists){continue}
      $labelOut = if($s.Label){$s.Label}else{"<unnamed>"}
      parts @(
        @{text=("  {0,2} " -f $s.Slot); rgb=$Baby; fallback='Cyan'},
        @{text=$labelOut; rgb=$White; fallback='White'}
      )
    }
  }

  line "" $White
  parts @(
    @{text="Type slot NUMBER to LOAD, '"; rgb=$White; fallback='White'},
    @{text="new"; rgb=$Baby; fallback='Cyan'},
    @{text="' to capture a NEW save, or '"; rgb=$White; fallback='White'},
    @{text="q"; rgb=$Baby; fallback='Cyan'},
    @{text="' to quit"; rgb=$White; fallback='White'}
  )
  $choice = Read-Host

  if($choice -match '^[Qq]$'){ break }

  if($choice -match '^[Nn](ew)?$'){
    if(-not (Test-Path -LiteralPath $LiveFolder)){
      parts @(@{text="Live folder not found: $LiveFolder"; rgb=$Red; fallback='Red'})
      continue
    }
    $next=Get-NextSlotNumber $SaveRoot
    $slotDir=Join-Path $SaveRoot $next
    Ensure-Dir $slotDir
    Copy-Item -LiteralPath $LiveFolder -Destination $slotDir -Recurse -Force
    line "What do you want to name the save? (optional)" $White 'White'
    $label = Read-Host
    $label = ($label -as [string]) -replace '^\s+|\s+$',''
    if($label){ $label | Set-Content -LiteralPath (Join-Path $slotDir 'name.txt') -Encoding UTF8 }
    $suffix = if($label){ " - $label"}else{""}
    line ("Saved slot {0}{1}." -f $next,$suffix) $DOS 'Green'
    continue
  }

  if(-not ($choice -as [int])){
    parts @(@{text="Invalid input. Enter a slot number, 'new', or 'q'."; rgb=$Red; fallback='Red'})
    continue
  }

  $slot=[int]$choice
  $slotDir=Join-Path $SaveRoot $slot
  $srcSave=Join-Path $slotDir $LiveName

  if(-not (Test-Path -LiteralPath $srcSave)){
    parts @(@{text="Slot $slot does not exist (no $LiveName found)."; rgb=$Red; fallback='Red'})
    continue
  }

  Ensure-Dir $LiveFolder
  line "Backing up current $LiveName (if present)..." $White 'White'
  Backup-Folder -Folder $LiveFolder -Keep $Keep
  line "Loading slot $slot -> live $LiveName ..." $White 'White'
  if(Test-Path -LiteralPath $LiveFolder){
    Get-ChildItem -LiteralPath $LiveFolder -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
  } else {
    Ensure-Dir $LiveFolder
  }
  Get-ChildItem -LiteralPath $srcSave -Force -ErrorAction SilentlyContinue | Copy-Item -Destination $LiveFolder -Recurse -Force
  line "Loaded slot $slot!" $DOS 'Green'
}
